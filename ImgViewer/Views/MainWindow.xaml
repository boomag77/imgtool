<Window x:Class="ImgViewer.Views.MainWindow"
        
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:ImgViewer"
        xmlns:views="clr-namespace:ImgViewer.Views"
        xmlns:conv="clr-namespace:ImgViewer.Converters"
        xmlns:models="clr-namespace:ImgViewer.Models"
        mc:Ignorable="d"
        Title="Image Genie" Width="1024" Height="768"
        Icon="Assets/IgAppIcon.ico"
        Background="LightGray"
        PreviewKeyDown="Window_PreviewKeyDown"
        MinHeight="600" MinWidth="800">
    <Window.Resources>

        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
        <conv:InverseBooleanToVisibilityConverter x:Key="InvBoolToVis"/>
        <conv:MultiplyConverter x:Key="MultiplyConverter"/>

        <DataTemplate x:Key="ParameterTemplate">
            <Border Padding="4" Margin="2"
                Visibility="{Binding IsVisible, Converter={StaticResource BoolToVis}}">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="150"/>
                        <!-- Label -->
                        <ColumnDefinition Width="*"/>
                        <!-- Editor -->
                    </Grid.ColumnDefinitions>

                    <!-- Label on the left -->
                    <TextBlock Grid.Column="0"
                           Text="{Binding Label}"
                           VerticalAlignment="Center"
                           Margin="4,0"/>

                    <!-- Editor: exactly ONE control via triggers -->
                    <ContentControl Grid.Column="1" VerticalAlignment="Center">
                        <ContentControl.Style>
                            <Style TargetType="ContentControl">
                                <!-- Default editor: numeric/text -->
                                <Setter Property="Content">
                                    
                                    <Setter.Value>
                                        <TextBox Width="100"
                                             VerticalAlignment="Center"
                                             Text="{Binding Value, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                                    </Setter.Value>
                                </Setter>

                                <Style.Triggers>
                                    <!-- Combo -->
                                    <DataTrigger Binding="{Binding IsCombo}" Value="True">
                                        <Setter Property="Content">
                                            <Setter.Value>
                                                <ComboBox Width="180"
                                                      VerticalAlignment="Center"
                                                      ItemsSource="{Binding Options}"
                                                      SelectedIndex="{Binding SelectedIndex, Mode=TwoWay}"/>
                                            </Setter.Value>
                                        </Setter>
                                    </DataTrigger>

                                    <!-- Checkbox -->
                                    <DataTrigger Binding="{Binding IsBool}" Value="True">
                                        <Setter Property="Content">
                                            <Setter.Value>
                                                <!-- No Content — label is already left -->
                                                <CheckBox IsChecked="{Binding BoolValue, Mode=TwoWay}"
                                                      VerticalAlignment="Center"
                                                      HorizontalAlignment="Left"/>
                                            </Setter.Value>
                                        </Setter>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </ContentControl.Style>
                    </ContentControl>
                </Grid>
            </Border>
        </DataTemplate>

        <SolidColorBrush x:Key="PipelineCardBackgroundBrush" Color="#2F3136"/>
        <SolidColorBrush x:Key="PipelineCardBorderBrush" Color="#464A52"/>
        <SolidColorBrush x:Key="PipelineTextBrush" Color="#E5E7EA"/>
        <SolidColorBrush x:Key="PipelineTextboxBackgroundBrush" Color="#1E2024"/>
        <Style x:Key="SpinnerRepeatButtonStyle" TargetType="RepeatButton">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderBrush" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="0"/>
            <Setter Property="Focusable" Value="False"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="RepeatButton">
                        <Border Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center"
                                              VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="PipelineCardListBoxItemStyle" TargetType="ListBoxItem">
            <Setter Property="Padding" Value="0"/>
            <Setter Property="Margin" Value="0,0,0,8"/>
            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
            <Setter Property="FontWeight" Value="Regular"/>
            <Setter Property="FontSize" Value="11"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ListBoxItem">
                        <Border Background="Transparent">
                            <ContentPresenter />
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="RoundedButton" TargetType="Button">
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Background" Value="#2F3136"/>
            <Setter Property="BorderBrush" Value="#2F3136"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="12,5"/>
            <Setter Property="MinWidth" Value="120"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border"
                            Background="{TemplateBinding Background}"
                            BorderBrush="{TemplateBinding BorderBrush}"
                            BorderThickness="{TemplateBinding BorderThickness}"
                            CornerRadius="10"
                            SnapsToDevicePixels="True">
                            <ContentPresenter HorizontalAlignment="Center"
                                          VerticalAlignment="Center"
                                          Margin="{TemplateBinding Padding}"/>
                        </Border>

                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#FF1E66E0"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#FF1553C0"/>
                                <Setter TargetName="border" Property="RenderTransform">
                                    <Setter.Value>
                                        <TranslateTransform Y="1"/>
                                    </Setter.Value>
                                </Setter>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="border" Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="ElevatedRoundedButton" TargetType="Button">
            <Setter Property="Background" Value="#2F3136"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Padding" Value="6,6"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Grid>
                            <!-- shadow -->
                            <Border CornerRadius="6" Background="Transparent" Margin="0,2,0,0">
                                <Border.Effect>
                                    <DropShadowEffect BlurRadius="8" ShadowDepth="2" Opacity="0.2"/>
                                </Border.Effect>
                            </Border>

                            <!-- main -->
                            <Border x:Name="bd"
                            CornerRadius="4"
                            Background="{TemplateBinding Background}"
                            BorderBrush="{TemplateBinding BorderBrush}"
                            BorderThickness="{TemplateBinding BorderThickness}">
                                <ContentPresenter HorizontalAlignment="Center"
                                                  VerticalAlignment="Center"
                                                  Margin="{TemplateBinding Padding}"/>
                            </Border>
                        </Grid>

                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="bd" Property="Opacity" Value="0.95"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="bd" Property="RenderTransform">
                                    <Setter.Value>
                                        <ScaleTransform ScaleX="0.99" ScaleY="0.99"/>
                                    </Setter.Value>
                                </Setter>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="PipelineHelpButtonStyle"
               TargetType="Button"
               BasedOn="{StaticResource ElevatedRoundedButton}">
            <Setter Property="Width" Value="24"/>
            <Setter Property="Height" Value="24"/>
            <Setter Property="Padding" Value="2,0"/>
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="HorizontalAlignment" Value="Right"/>
            <Setter Property="VerticalAlignment" Value="Bottom"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Grid>
                            <Border CornerRadius="14" Background="Transparent" Margin="0,2,0,0">
                                <Border.Effect>
                                    <DropShadowEffect BlurRadius="8" ShadowDepth="2" Opacity="0.2"/>
                                </Border.Effect>
                            </Border>
                            <Border x:Name="bd"
                                    CornerRadius="14"
                                    Background="{TemplateBinding Background}"
                                    BorderBrush="{TemplateBinding BorderBrush}"
                                    BorderThickness="{TemplateBinding BorderThickness}">
                                <ContentPresenter HorizontalAlignment="Center"
                                                  VerticalAlignment="Center"
                                                  Margin="{TemplateBinding Padding}"/>
                            </Border>
                        </Grid>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="bd" Property="Opacity" Value="0.95"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="bd" Property="RenderTransform">
                                    <Setter.Value>
                                        <ScaleTransform ScaleX="0.99" ScaleY="0.99"/>
                                    </Setter.Value>
                                </Setter>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="StatusBarToggleButtonStyle" TargetType="ToggleButton">
            <Setter Property="Width" Value="28"/>
            <Setter Property="Height" Value="22"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Background" Value="#2F3136"/>
            <Setter Property="BorderBrush" Value="Transparent"/>
            <Setter Property="Padding" Value="2,0"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Grid>
                            <Border CornerRadius="6" Background="Transparent" Margin="0,2,0,0">
                                <Border.Effect>
                                    <DropShadowEffect BlurRadius="6" ShadowDepth="1" Opacity="0.15"/>
                                </Border.Effect>
                            </Border>
                            <Border x:Name="bd"
                                    CornerRadius="4"
                                    Background="{TemplateBinding Background}"
                                    BorderBrush="{TemplateBinding BorderBrush}"
                                    BorderThickness="{TemplateBinding BorderThickness}">
                                <ContentPresenter HorizontalAlignment="Center"
                                                  VerticalAlignment="Center"
                                                  Margin="{TemplateBinding Padding}"/>
                            </Border>
                        </Grid>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="bd" Property="Opacity" Value="0.9"/>
                            </Trigger>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="bd" Property="Background" Value="#FF1E66E0"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="bd" Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="StatusBarButtonStyle" TargetType="Button">
            <Setter Property="Width" Value="32"/>
            <Setter Property="Height" Value="22"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Background" Value="#2F3136"/>
            <Setter Property="BorderBrush" Value="Transparent"/>
            <Setter Property="Padding" Value="2,0"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Grid>
                            <Border CornerRadius="6" Background="Transparent" Margin="0,2,0,0">
                                <Border.Effect>
                                    <DropShadowEffect BlurRadius="6" ShadowDepth="1" Opacity="0.15"/>
                                </Border.Effect>
                            </Border>
                            <Border x:Name="bd"
                                    CornerRadius="4"
                                    Background="{TemplateBinding Background}"
                                    BorderBrush="{TemplateBinding BorderBrush}"
                                    BorderThickness="{TemplateBinding BorderThickness}">
                                <ContentPresenter HorizontalAlignment="Center"
                                                  VerticalAlignment="Center"
                                                  Margin="{TemplateBinding Padding}"/>
                            </Border>
                        </Grid>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="bd" Property="Opacity" Value="0.9"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="bd" Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="PreviewCloseButtonStyle" TargetType="Button">
            <Setter Property="Width" Value="20"/>
            <Setter Property="Height" Value="20"/>
            <Setter Property="FontSize" Value="10"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Background" Value="#2F3136"/>
            <Setter Property="BorderBrush" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="bd"
                                Background="{TemplateBinding Background}"
                                CornerRadius="3"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}">
                            <ContentPresenter HorizontalAlignment="Center"
                                              VerticalAlignment="Center"
                                              Margin="{TemplateBinding Padding}"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="bd" Property="Background" Value="#FF1E66E0"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="bd" Property="Opacity" Value="0.85"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="bd" Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="SplitPreviewTileBaseStyle" TargetType="Viewbox">
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Margin" Value="2"/>
            <Setter Property="Stretch" Value="Uniform"/>
            <Setter Property="Panel.ZIndex" Value="1"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <BlurEffect Radius="0"/>
                </Setter.Value>
            </Setter>
            <Setter Property="Opacity" Value="1"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding HasFocusedSplitPreview}" Value="True">
                    <Setter Property="Effect">
                        <Setter.Value>
                            <BlurEffect Radius="4"/>
                        </Setter.Value>
                    </Setter>
                    <Setter Property="Opacity" Value="0.6"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>
        <Style x:Key="SplitPreviewTileStyle0" TargetType="Viewbox" BasedOn="{StaticResource SplitPreviewTileBaseStyle}">
            <Style.Triggers>
                <MultiDataTrigger>
                    <MultiDataTrigger.Conditions>
                        <Condition Binding="{Binding HasFocusedSplitPreview}" Value="True"/>
                        <Condition Binding="{Binding FocusedSplitPreviewIndex}" Value="0"/>
                    </MultiDataTrigger.Conditions>
                    <Setter Property="Effect">
                        <Setter.Value>
                            <BlurEffect Radius="0"/>
                        </Setter.Value>
                    </Setter>
                    <Setter Property="Opacity" Value="1"/>
                    <Setter Property="Panel.ZIndex" Value="5"/>
                </MultiDataTrigger>
            </Style.Triggers>
        </Style>
        <Style x:Key="SplitPreviewTileStyle1" TargetType="Viewbox" BasedOn="{StaticResource SplitPreviewTileBaseStyle}">
            <Style.Triggers>
                <MultiDataTrigger>
                    <MultiDataTrigger.Conditions>
                        <Condition Binding="{Binding HasFocusedSplitPreview}" Value="True"/>
                        <Condition Binding="{Binding FocusedSplitPreviewIndex}" Value="1"/>
                    </MultiDataTrigger.Conditions>
                    <Setter Property="Effect">
                        <Setter.Value>
                            <BlurEffect Radius="0"/>
                        </Setter.Value>
                    </Setter>
                    <Setter Property="Opacity" Value="1"/>
                    <Setter Property="Panel.ZIndex" Value="5"/>
                </MultiDataTrigger>
            </Style.Triggers>
        </Style>
        <Style x:Key="SplitPreviewTileStyle2" TargetType="Viewbox" BasedOn="{StaticResource SplitPreviewTileBaseStyle}">
            <Style.Triggers>
                <MultiDataTrigger>
                    <MultiDataTrigger.Conditions>
                        <Condition Binding="{Binding HasFocusedSplitPreview}" Value="True"/>
                        <Condition Binding="{Binding FocusedSplitPreviewIndex}" Value="2"/>
                    </MultiDataTrigger.Conditions>
                    <Setter Property="Effect">
                        <Setter.Value>
                            <BlurEffect Radius="0"/>
                        </Setter.Value>
                    </Setter>
                    <Setter Property="Opacity" Value="1"/>
                    <Setter Property="Panel.ZIndex" Value="5"/>
                </MultiDataTrigger>
            </Style.Triggers>
        </Style>
        <Style x:Key="SplitPreviewTileStyle3" TargetType="Viewbox" BasedOn="{StaticResource SplitPreviewTileBaseStyle}">
            <Style.Triggers>
                <MultiDataTrigger>
                    <MultiDataTrigger.Conditions>
                        <Condition Binding="{Binding HasFocusedSplitPreview}" Value="True"/>
                        <Condition Binding="{Binding FocusedSplitPreviewIndex}" Value="3"/>
                    </MultiDataTrigger.Conditions>
                    <Setter Property="Effect">
                        <Setter.Value>
                            <BlurEffect Radius="0"/>
                        </Setter.Value>
                    </Setter>
                    <Setter Property="Opacity" Value="1"/>
                    <Setter Property="Panel.ZIndex" Value="5"/>
                </MultiDataTrigger>
            </Style.Triggers>
        </Style>
        <Style x:Key="SplitPreviewTileStyle4" TargetType="Viewbox" BasedOn="{StaticResource SplitPreviewTileBaseStyle}">
            <Style.Triggers>
                <MultiDataTrigger>
                    <MultiDataTrigger.Conditions>
                        <Condition Binding="{Binding HasFocusedSplitPreview}" Value="True"/>
                        <Condition Binding="{Binding FocusedSplitPreviewIndex}" Value="4"/>
                    </MultiDataTrigger.Conditions>
                    <Setter Property="Effect">
                        <Setter.Value>
                            <BlurEffect Radius="0"/>
                        </Setter.Value>
                    </Setter>
                    <Setter Property="Opacity" Value="1"/>
                    <Setter Property="Panel.ZIndex" Value="5"/>
                </MultiDataTrigger>
            </Style.Triggers>
        </Style>
        <Style x:Key="SplitPreviewTileStyle5" TargetType="Viewbox" BasedOn="{StaticResource SplitPreviewTileBaseStyle}">
            <Style.Triggers>
                <MultiDataTrigger>
                    <MultiDataTrigger.Conditions>
                        <Condition Binding="{Binding HasFocusedSplitPreview}" Value="True"/>
                        <Condition Binding="{Binding FocusedSplitPreviewIndex}" Value="5"/>
                    </MultiDataTrigger.Conditions>
                    <Setter Property="Effect">
                        <Setter.Value>
                            <BlurEffect Radius="0"/>
                        </Setter.Value>
                    </Setter>
                    <Setter Property="Opacity" Value="1"/>
                    <Setter Property="Panel.ZIndex" Value="5"/>
                </MultiDataTrigger>
            </Style.Triggers>
        </Style>
        <!-- Pipeline-styled ComboBox (paste inside Window.Resources) -->
        <Style x:Key="PipelineComboBoxStyle" TargetType="ComboBox">
            <Setter Property="Foreground" Value="{StaticResource PipelineTextBrush}" />
            <Setter Property="Background" Value="{StaticResource PipelineTextboxBackgroundBrush}" />
            <Setter Property="BorderBrush" Value="{StaticResource PipelineCardBorderBrush}" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="Padding" Value="6,2" />
            <Setter Property="MinWidth" Value="10" />
            <Setter Property="SnapsToDevicePixels" Value="True"/>
            <Setter Property="FontSize" Value="10"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ComboBox">
                        <Grid>
                            <Border x:Name="Bd"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="3"
                                SnapsToDevicePixels="True"> 
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>

                                    <!-- content goes in column 0 and fills available space -->
                                    <ContentPresenter x:Name="ContentSite"
                                                      Grid.Column="0"
                                                      Margin="{TemplateBinding Padding}"
                                                      VerticalAlignment="Center"
                                                      HorizontalAlignment="Right"   
                                                      Content="{TemplateBinding SelectionBoxItem}"
                                                      ContentTemplate="{TemplateBinding SelectionBoxItemTemplate}"
                                                      RecognizesAccessKey="True" /> 

                                    <!-- toggle sits in column 1 with fixed width and won't stretch -->
                                        <ToggleButton x:Name="Toggle"
                                                      Grid.Column="1"
                                                      Width="16"
                                                      Focusable="False"
                                                      IsChecked="{Binding Path=IsDropDownOpen, Mode=TwoWay, RelativeSource={RelativeSource TemplatedParent}}"
                                                      Background="Transparent"
                                                      BorderBrush="Transparent"
                                                      BorderThickness="0"
                                                      VerticalAlignment="Center"
                                                      HorizontalAlignment="Right"
                                                      Margin="{TemplateBinding Padding}">
                                            <!-- small outer padding -->
                                            <Viewbox Width="10" Height="10">
                                                <Path Data="M0,0 L5,5 10,0 Z" Fill="{StaticResource PipelineTextBrush}"/>
                                            </Viewbox>
                                        </ToggleButton>
                                </Grid>
                            </Border>

                            <Popup x:Name="PART_Popup"
                                   Placement="Bottom"
                                   IsOpen="{Binding Path=IsDropDownOpen, RelativeSource={RelativeSource TemplatedParent}}"
                                   AllowsTransparency="True"
                                   Focusable="False"
                                   PopupAnimation="Fade">
                                <Border Background="{StaticResource PipelineCardBackgroundBrush}"
                                        BorderBrush="{StaticResource PipelineCardBorderBrush}"
                                        BorderThickness="1"
                                        CornerRadius="3"
                                        Margin="0,6,0,0"
                                        SnapsToDevicePixels="True">
                                    <ScrollViewer CanContentScroll="True"
                                                  HorizontalScrollBarVisibility="Disabled"
                                                  VerticalScrollBarVisibility="Auto"
                                                  MaxHeight="280"
                                                  Padding="2">  
                                        <ItemsPresenter/>
                                    </ScrollViewer>
                                </Border>
                            </Popup>
                        </Grid>

                        <ControlTemplate.Triggers>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="Bd" Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- ComboBoxItem style (list items in popup) -->
        <Style x:Key="PipelineComboBoxItemStyle" TargetType="ComboBoxItem">
            <Setter Property="Foreground" Value="{StaticResource PipelineTextBrush}" />
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="Padding" Value="8,6" />
            <Setter Property="HorizontalContentAlignment" Value="Left" />
            <Setter Property="VerticalContentAlignment" Value="Center" />
            <Setter Property="FontSize" Value="11"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ComboBoxItem">
                        <Border x:Name="Bd" Background="{TemplateBinding Background}" CornerRadius="3">
                            <ContentPresenter HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                                      VerticalAlignment="{TemplateBinding VerticalContentAlignment}"
                                      Margin="{TemplateBinding Padding}" />
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="{StaticResource PipelineCardBorderBrush}"/>
                            </Trigger>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="#FF1E66E0"/>
                                <Setter Property="Foreground" Value="White"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>


        <Style x:Key="PipelineCheckBoxStyle" TargetType="CheckBox">
            <Setter Property="Foreground" Value="{StaticResource PipelineTextBrush}"/>
            <Setter Property="FontSize" Value="11"/>
            <Setter Property="Padding" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="CheckBox">
                        <Grid>
                            <!-- Box -->
                            <Border x:Name="Box"
                                    Width="15" Height="15"
                                    CornerRadius="3"
                                    Background="{StaticResource PipelineTextboxBackgroundBrush}"
                                    BorderBrush="{StaticResource PipelineCardBorderBrush}"
                                    BorderThickness="1"
                                    VerticalAlignment="Center"
                                    HorizontalAlignment="Left"/>    

                            <!-- Vector check mark - stroke binds to Foreground so it matches text -->
                            <Path x:Name="CheckMark"
                                  Data="M2,2 L6,7 L10,1"
                                  Stroke="{TemplateBinding Foreground}"
                                  StrokeThickness="1.0"
                                  StrokeLineJoin="Round"
                                  StrokeStartLineCap="Round"
                                  StrokeEndLineCap="Round"
                                  Visibility="Collapsed"
                                  HorizontalAlignment="Stretch"
                                  VerticalAlignment="Center"
                                  Margin="1,1,0,0"/>        

                            <!-- Label: use TextElement.Foreground to color text correctly -->
                            <ContentPresenter x:Name="content"
                                      ContentSource="Content"
                                      Margin="24,0,0,0"
                                      VerticalAlignment="Center"
                                      RecognizesAccessKey="True"
                                      TextElement.Foreground="{TemplateBinding Foreground}" />
                        </Grid>

                        <ControlTemplate.Triggers>
                            <!-- show check when checked -->
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="CheckMark" Property="Visibility" Value="Visible"/>
                                <!-- optional: change box background on checked 
                                <Setter TargetName="Box" Property="Background" Value="{StaticResource PipelineCardBorderBrush}"/> -->
                            </Trigger>

                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>





    </Window.Resources>

    <AdornerDecorator>
    
    <Grid x:Name="RootGrid">
        <Grid.RowDefinitions>
            <!-- Menu bar row -->
            <RowDefinition Height="Auto"/>
            <!--Upper controls -->
            <RowDefinition Height="Auto"/>
            <!-- Main content row -->
            <RowDefinition x:Name="MainContentRow" Height="*"/>
            <!--Lower controls-->
            <RowDefinition Height="Auto"/>
            <!--Status bar row -->
            <RowDefinition Height="Auto"/>
            
        </Grid.RowDefinitions>
        
        <Grid.ColumnDefinitions>

            <!--Original image -->
            <ColumnDefinition Width="4*"/>
            <!--Pipeline and controls -->
            <ColumnDefinition Width="2*" MinWidth="370"/>
            <!--Processing image -->
            <ColumnDefinition x:Name="ProcessingImageColumn" Width="4*"/>
            
        </Grid.ColumnDefinitions>

        <!--Menu -->
        <Menu Grid.Row="0" VerticalAlignment="Top" Grid.ColumnSpan="3">
            <MenuItem Header="_File">
                <MenuItem Header="_Open Image" Click="OpenFile_Click"/>
                <Separator/>
                <MenuItem Header="_Save Image As..." Click="SaveAs_Click"/>
                <Separator/>
                <MenuItem Header="_Tiff compression" Click="SavingOptions_Click"/>
                <Separator/>
                <MenuItem Header="_Exit" Click="ExitClick"/>
            </MenuItem>
            <MenuItem Header="_Settings">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Grid.Column="0"
               VerticalAlignment="Center"
               Text="Save PL to MetaData"/>
                        <CheckBox Grid.Column="1"
              IsChecked="{Binding SavePipelineToMd, Mode=TwoWay}"
              VerticalAlignment="Center"
              Margin="6,0,0,0"/>
                    </Grid>
                </MenuItem>
            <MenuItem Header="_Help"
                      Click="DocumentationMenu_Click"/>
        </Menu>
        
        <!-- Status bar -->
        <StatusBar Grid.Row="4" Grid.ColumnSpan="3" VerticalAlignment="Bottom">
            <StatusBarItem>
                <TextBlock x:Name="StatusText" Text="{Binding Status}" />
            </StatusBarItem>
            <StatusBarItem>
                <ProgressBar x:Name="MyProgressBar" Width="200" Height="16" Minimum="0" Maximum="100" />
            </StatusBarItem>
            <StatusBarItem HorizontalAlignment="Right">
                <TextBlock HorizontalAlignment="Right" Text="{Binding TiffCompressionLabel}"/>
            </StatusBarItem>
            <StatusBarItem HorizontalAlignment="Right">
                <StackPanel Orientation="Horizontal">
                    <ToggleButton Content="V"
                                  Style="{StaticResource StatusBarToggleButtonStyle}"
                                  Margin="0,0,4,0"
                                  ToolTip="Split preview vertically"
                                  IsChecked="{Binding IsVerticalSplitPreview, Mode=TwoWay}"
                                  IsEnabled="{Binding AreSplitOrientationButtonsEnabled}"/>
                    <ToggleButton Content="H"
                                  Style="{StaticResource StatusBarToggleButtonStyle}"
                                  ToolTip="Split preview horizontally"
                                  IsChecked="{Binding IsHorizontalSplitPreview, Mode=TwoWay}"
                                  IsEnabled="{Binding AreSplitOrientationButtonsEnabled}"/>
                    <Button x:Name="SplitCountButton"
                            Content="{Binding PreviewSplitCountLabel}"
                            Margin="6,0,0,0"
                            Style="{StaticResource StatusBarButtonStyle}"
                            ToolTip="Choose number of preview panes"
                            Click="SplitCountButton_Click">
                        <Button.ContextMenu>
                            <ContextMenu>
                                <MenuItem Header="2 views"
                                          Tag="2"
                                          Click="SplitCountMenuItem_Click"/>
                                <MenuItem Header="4 views"
                                          Tag="4"
                                          Click="SplitCountMenuItem_Click"/>
                                <MenuItem Header="6 views"
                                          Tag="6"
                                          Click="SplitCountMenuItem_Click"/>
                            </ContextMenu>
                        </Button.ContextMenu>
                    </Button>
                </StackPanel>
            </StatusBarItem>
        </StatusBar>

        <!-- Pipeline -->
        <Border Grid.Row="1" Grid.Column="1" Grid.RowSpan="2"
                BorderThickness="1"
                BorderBrush="DarkGray"
                Padding="6"
                Margin="6"
                CornerRadius="6"
                Background="DarkGray">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                <!-- Title -->
                <TextBlock
                    Grid.Row="0"
                    Margin="5,5,5,5"
                    Text="Pipeline"/>
                <!-- Load/Save preset buttons -->
                <StackPanel Orientation="Horizontal"
                            HorizontalAlignment="Center"
                            
                            Grid.Row="1">
                    <Button Style="{StaticResource ElevatedRoundedButton}"
                            Margin="5,5,5,5"
                            Click="LoadPipelinePreset_Click">
                            Load preset
                    </Button>
                    <Button Style="{StaticResource ElevatedRoundedButton}"
                            Margin="5,5,5,5"
                            Click="SavePipelinePreset_Click">
                            Save preset
                    </Button>
                    <Button Style="{StaticResource ElevatedRoundedButton}"
                            Margin="5,5,5,5"
                            Click="ResetPipelineToDefaults_Click">
                            Reset to defauts
                    </Button>
                    <Button Style="{StaticResource ElevatedRoundedButton}"
                            Margin="5,5,5,5"
                            Click="AddPipelineOperation_Click">      
                            +
                        <Button.ContextMenu>
                            <ContextMenu x:Name="AddOperationContextMenu"
                                         Opened="AddOperationContextMenu_Opened">
                                <MenuItem Header="Deskew"
                                      Tag="{x:Static models:PipelineOperationType.Deskew}"
                                      Click="AddOperationMenuItem_Click" />
                                                <MenuItem Header="Border Removal"
                                      Tag="{x:Static models:PipelineOperationType.BordersRemove}"
                                      Click="AddOperationMenuItem_Click" />
                                                <MenuItem Header="Binarize"
                                      Tag="{x:Static models:PipelineOperationType.Binarize}"
                                      Click="AddOperationMenuItem_Click" />
                                                <MenuItem Header="Enhance"
                                      Tag="{x:Static models:PipelineOperationType.Enhance}"
                                      Click="AddOperationMenuItem_Click" />
                                                <MenuItem Header="Punch holes"
                                      Tag="{x:Static models:PipelineOperationType.PunchHolesRemove}"
                                      Click="AddOperationMenuItem_Click" />
                                                <MenuItem Header="Despeckle"
                                      Tag="{x:Static models:PipelineOperationType.Despeckle}"
                                      Click="AddOperationMenuItem_Click" />
                                                <MenuItem Header="Lines remove"
                                      Tag="{x:Static models:PipelineOperationType.LinesRemove}"
                                      Click="AddOperationMenuItem_Click" />
                                    <MenuItem Header="Crop"
                                      Tag="{x:Static models:PipelineOperationType.SmartCrop}"
                                      Click="AddOperationMenuItem_Click" /> 
                                    <MenuItem Header="Split Page"
                                      Tag="{x:Static models:PipelineOperationType.SplitPage}"
                                      Click="AddOperationMenuItem_Click" />
                            </ContextMenu>
                        </Button.ContextMenu>
                    </Button>
                </StackPanel>
                <!-- Pipeline steps cards -->
                <ListBox x:Name="PipelineListBox"
                         Grid.Row="2"
                         Margin="0"
                         Padding="5,10,5,10"
                         ItemsSource="{Binding Pipeline.Operations,
                                        RelativeSource={RelativeSource AncestorType=Window}}"
                         Background="Transparent"
                         BorderThickness="0"
                         AllowDrop="True"
                         HorizontalContentAlignment="Stretch"
                         VerticalAlignment="Top"
                         ItemContainerStyle="{StaticResource PipelineCardListBoxItemStyle}"
                         PreviewMouseLeftButtonDown="PipelineListBox_PreviewMouseLeftButtonDown"
                         PreviewMouseMove="PipelineListBox_PreviewMouseMove"
                         DragEnter="PipelineListBox_DragEnter"
                         DragOver="PipelineListBox_DragOver"
                         DragLeave="PipelineListBox_DragLeave"
                         Drop="PipelineListBox_Drop"
                         GiveFeedback="PipelineListBox_GiveFeedback"
                         
                         ScrollViewer.VerticalScrollBarVisibility="Auto"
                         ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                         ScrollViewer.CanContentScroll="True"
                         VirtualizingStackPanel.IsVirtualizing="True"
                         VirtualizingStackPanel.VirtualizationMode="Recycling"
                         VirtualizingStackPanel.ScrollUnit="Pixel"   
                         VirtualizingStackPanel.CacheLength="2"
                         VirtualizingStackPanel.CacheLengthUnit="Page"
                         VirtualizingPanel.IsVirtualizingWhenGrouping="True"
                         ScrollViewer.PanningMode="VerticalOnly"
                         ScrollViewer.IsDeferredScrollingEnabled="False" >
                    <ListBox.Resources>
                        <Style TargetType="ScrollViewer">
                            <Setter Property="VerticalScrollBarVisibility" Value="Auto"/>
                            <Setter Property="HorizontalScrollBarVisibility" Value="Disabled"/>
                        </Style>
                    </ListBox.Resources>
                    
                    
                    <ListBox.ItemTemplate>
                        <DataTemplate DataType="{x:Type models:PipelineOperation}">
                                <Border CornerRadius="6"
                                        Background="{StaticResource PipelineCardBackgroundBrush}"
                                        Padding="0">
                                    <Expander
                                        IsExpanded="{Binding IsExpanded}"
                                        Padding="5,3,5,3"
                                        HorizontalAlignment="Stretch"
                                        Background="{StaticResource PipelineCardBackgroundBrush}"
    >
                                        <!-- The card header -->
                                        <Expander.Header>
                                            <Border CornerRadius="5" Background="Transparent">
                                                <Grid Margin="5"
                                                     Width="{Binding
                                                              RelativeSource={RelativeSource AncestorType={x:Type Expander}},
                                                              Path=ActualWidth}">
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*" />
                                                        <ColumnDefinition Width="Auto" />
                                                        <ColumnDefinition Width="*" />
                                                    </Grid.ColumnDefinitions>

                                                    <TextBlock Grid.Column="0"
                                                               Text="{Binding DisplayName}"
                                                               Foreground="{StaticResource PipelineTextBrush}"
                                                               FontWeight="SemiBold"
                                                               FontSize="14"
                                                               VerticalAlignment="Center"/>

                                                    <CheckBox Grid.Column="1"
                                                              Margin="12,0,8,0"
                                                              VerticalAlignment="Center"
                                                              Content="In pipeline"
                                                              Foreground="{StaticResource PipelineTextBrush}"
                                                              IsChecked="{Binding InPipeline}" />

                                                    <CheckBox Grid.Column="2"
                                                              Margin="12,0,8,0"
                                                              VerticalAlignment="Center"
                                                              Content="Live"
                                                              Foreground="{StaticResource PipelineTextBrush}"
                                                              IsChecked="{Binding Live}" />
                                                </Grid>
                                            </Border>
                                        </Expander.Header>
                                        <Border Background="Transparent"
                                                BorderBrush="{StaticResource PipelineCardBorderBrush}"
                                                BorderThickness="1"
                                                CornerRadius="6"
                                                Padding="12"
                                                SnapsToDevicePixels="True">
                                            <StackPanel>
                                                <Grid>
                                                    <Grid.RowDefinitions>
                                                        <RowDefinition/>
                                                        <RowDefinition Height="Auto"/>
                                                    </Grid.RowDefinitions>

                                                    <ItemsControl Grid.Row="0"
                                                                  ItemsSource="{Binding Parameters}">
                                                    <ItemsControl.Style>
                                                        <Style TargetType="ItemsControl">
                                                            <Setter Property="Margin" Value="0,0,0,4"/>
                                                            <Style.Triggers>
                                                                <Trigger Property="HasItems" Value="False">
                                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                                </Trigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </ItemsControl.Style>
                                                    <ItemsControl.ItemsPanel>
                                                        <ItemsPanelTemplate>
                                                            <WrapPanel />
                                                        </ItemsPanelTemplate>
                                                    </ItemsControl.ItemsPanel>

                                                    <ItemsControl.ItemTemplate>
                                                        <DataTemplate DataType="{x:Type models:PipeLineParameter}">
                                                            <StackPanel Orientation="Horizontal"
                                                                        Margin="0,0,15,7"
                                                                        VerticalAlignment="Center"
                                                                        Visibility="{Binding IsVisible, Converter={StaticResource BoolToVis}}">
                                                                <TextBlock x:Name="ParamLabel"
                                                                           Text="{Binding Label}"
                                                                           FontWeight="Regular"
                                                                           Foreground="{StaticResource PipelineTextBrush}"
                                                                           VerticalAlignment="Center"
                                                                           Margin="0,0,5,0">
                                                                    <TextBlock.Style>
                                                                        <Style TargetType="TextBlock">
                                                                            <Setter Property="Visibility" Value="Visible"/>
                                                                            <Style.Triggers>
                                                                                <!-- скрываем левый лейбл если параметр булев -->
                                                                                <DataTrigger Binding="{Binding IsBool}" Value="True">
                                                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                                                </DataTrigger>
                                                                            </Style.Triggers>
                                                                        </Style>
                                                                    </TextBlock.Style>
                                                                </TextBlock>

                                                                <!-- Outer border kept same (hidden for bool parameters) -->
                                                                <Border Background="{StaticResource PipelineTextboxBackgroundBrush}"
                                                                        BorderBrush="{StaticResource PipelineCardBorderBrush}"
                                                                        BorderThickness="1"
                                                                        CornerRadius="3"
                                                                        HorizontalAlignment="Left"
                                                                        Visibility="{Binding IsBool, Converter={StaticResource InvBoolToVis}}">
                                                                    <Grid>
                                                                        <Grid.ColumnDefinitions>
                                                                            <ColumnDefinition Width="*"/>
                                                                            <ColumnDefinition Width="Auto"/>
                                                                        </Grid.ColumnDefinitions>

                                                                        <!-- EDITOR: exactly ONE control via triggers -->
                                                                        <ContentControl Grid.Column="0" VerticalAlignment="Center">
                                                                            <ContentControl.Style>
                                                                                <Style TargetType="ContentControl">
                                                                                    <!-- Default editor: numeric/text -->
                                                                                    <Setter Property="Content">
                                                                                        <Setter.Value>
                                                                                            <TextBox Text="{Binding Value, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged, StringFormat={}{0:0.##}}"
                                                                                                     Background="Transparent"
                                                                                                     Foreground="{StaticResource PipelineTextBrush}"
                                                                                                     BorderThickness="0"
                                                                                                     Padding="6,2"
                                                                                                     HorizontalContentAlignment="Right"
                                                                                                     VerticalContentAlignment="Center"
                                                                                                     MinWidth="40"
                                                                                                     MaxWidth="140"
                                                                                                     FontSize="11"/>
                                                                                        </Setter.Value>
                                                                                    </Setter>

                                                                                    <Style.Triggers>
                                                                                        <!-- Combo -->
                                                                                        <DataTrigger Binding="{Binding IsCombo}" Value="True">
                                                                                            <Setter Property="Content">
                                                                                                <Setter.Value>
                                                                                                    <ComboBox MinWidth="50"
                                                                                                              ItemsSource="{Binding Options}"
                                                                                                              SelectedIndex="{Binding SelectedIndex, Mode=TwoWay}"
                                                                                                              Style="{StaticResource PipelineComboBoxStyle}"
                                                                                                              ItemContainerStyle="{StaticResource PipelineComboBoxItemStyle}"
                                                                                                              Background="Transparent"
                                                                                                              Foreground="{StaticResource PipelineTextBrush}"
                                                                                                              BorderThickness="0"
                                                                                                              HorizontalAlignment="Stretch"
                                                                                                              HorizontalContentAlignment="Right"
                                                                                                              VerticalContentAlignment="Center"
                                                                                                              FontSize="11"/>
                                                                                                </Setter.Value>
                                                                                            </Setter>
                                                                                        </DataTrigger>
                                                                                    </Style.Triggers>
                                                                                </Style>
                                                                            </ContentControl.Style>
                                                                        </ContentControl>

                                                                        <!-- SPINNERS: visible only when NOT combo AND NOT bool -->
                                                                        <Grid Grid.Column="1"
                                                                            Margin="0,0,5,0">
                                                                            <Grid.Style>
                                                                                <Style TargetType="Grid">
                                                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                                                    <Style.Triggers>
                                                                                        <MultiDataTrigger>
                                                                                            <MultiDataTrigger.Conditions>
                                                                                                <Condition Binding="{Binding IsCombo}" Value="False"/>
                                                                                                <Condition Binding="{Binding IsBool}"  Value="False"/>
                                                                                            </MultiDataTrigger.Conditions>
                                                                                            <Setter Property="Visibility" Value="Visible"/>
                                                                                        </MultiDataTrigger>
                                                                                    </Style.Triggers>
                                                                                </Style>
                                                                            </Grid.Style>

                                                                            <Grid.RowDefinitions>
                                                                                <RowDefinition/>
                                                                                <RowDefinition/>
                                                                            </Grid.RowDefinitions>

                                                                            <RepeatButton Grid.Row="0"
                                                                                          Click="SpinnerUp_Click"
                                                                                          Style="{StaticResource SpinnerRepeatButtonStyle}">
                                                                                <Viewbox Width="8" Height="5">
                                                                                    <Path Data="M0,4 L4,0 8,4 Z"
                                                                                            Fill="{StaticResource PipelineTextBrush}"/>
                                                                                </Viewbox>
                                                                            </RepeatButton>

                                                                            <RepeatButton Grid.Row="1"
                                                                                          Click="SpinnerDown_Click"
                                                                                          Style="{StaticResource SpinnerRepeatButtonStyle}">
                                                                                <Viewbox Width="8" Height="5">
                                                                                    <Path Data="M0,0 L4,4 8,0 Z"
                                                                                            Fill="{StaticResource PipelineTextBrush}"/>
                                                                                </Viewbox>
                                                                            </RepeatButton>
                                                                        </Grid>
                                                                    </Grid>

                                                                </Border>
                                                                <!-- BOOL parameter: CheckBox OUTSIDE the editor border (shows label to the right) -->
                                                                <StackPanel Orientation="Horizontal"
                                                                            VerticalAlignment="Center"
                                                                            Visibility="{Binding IsBool, Converter={StaticResource BoolToVis}}"
                                                                            Margin="0,0,0,0">
                                                                    <CheckBox IsChecked="{Binding BoolValue, Mode=TwoWay}"
                                                                              Style="{StaticResource PipelineCheckBoxStyle}"  
                                                                              VerticalAlignment="Center"
                                                                              HorizontalAlignment="Left"
                                                                              Background="Transparent"
                                                                              BorderThickness="0"
                                                                              Margin="0"/>
                                                                    <TextBlock Text="{Binding Label}"
                                                                               Foreground="{StaticResource PipelineTextBrush}"
                                                                               VerticalAlignment="Center"
                                                                               Margin="6,0,0,0"
                                                                               FontSize="11"/>
                                                                </StackPanel>
                                                                
                                                            </StackPanel>
                                                        </DataTemplate>
                                                    </ItemsControl.ItemTemplate>
                                                    </ItemsControl>
                                                    <Button Grid.Row="1"
                                                            Margin="0,12,0,0"
                                                            Content="?"
                                                            ToolTip="Open help for this operation"
                                                            Tag="{Binding DocumentationSectionId}"
                                                            Click="OperationHelpButton_Click">
                                                        <Button.Style>
                                                            <Style TargetType="Button" BasedOn="{StaticResource PipelineHelpButtonStyle}">
                                                                <Setter Property="Visibility" Value="Visible"/>
                                                                <Style.Triggers>
                                                                    <Trigger Property="Tag" Value="{x:Null}">
                                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                                    </Trigger>
                                                                    <Trigger Property="Tag" Value="">
                                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                                    </Trigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </Button.Style>
                                                    </Button>
                                                </Grid>
                                                <!--
                                                <Button Content="Get from selection"
                                                        Margin="0,8,0,0"
                                                        HorizontalAlignment="Right"
                                                        Padding="12,4"
                                                        MinWidth="120"
                                                        Click="GetFromSelection_Click"
                                                        Visibility="{Binding
                                                                    SelectedItem.IsManualBordersRemove,
                                                                    ElementName=PipelineOperation,
                                                                    Converter={StaticResource BoolToVis}}"/>
                                                <Button Content="{Binding ActionLabel}"
                                                        Margin="0,8,0,0"
                                                        HorizontalAlignment="Right"
                                                        Padding="12,4"
                                                        MinWidth="120"
                                                        Click="PipelineRunButton_Click"/> -->
                                            </StackPanel>
                                        </Border>
                                    </Expander>
                                </Border>
                                
                            </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
                <StackPanel Grid.Row="3">
                    <StackPanel Orientation="Vertical"
                                HorizontalAlignment="Center">
                        <TextBlock
                            Margin="5,5,5,5"
                            HorizontalAlignment="Center"
                            Text="Apply Pipeline Parameters to..."/>
                        <StackPanel Orientation="Horizontal"
                            HorizontalAlignment="Center"
                            VerticalAlignment="Center"
                            Margin="10">
                            <Button Style="{StaticResource ElevatedRoundedButton}"
                                    Margin="5" Width="Auto" 
                                    Click="ApplyCurrentPipelineToCurrentFolder_Click">
                                <StackPanel Orientation="Horizontal" VerticalAlignment="Center" HorizontalAlignment="Center">
                                    <Viewbox Width="14" Height="14" Stretch="Uniform">
                                        <Canvas Width="8" Height="10">
                                            <!-- triangle polygon; Fill bound to Button.Foreground so it inherits color -->
                                            <Polygon Points="0,0 0,10 8,5"
                                                Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}"/>
                                        </Canvas>
                                    </Viewbox>
                                    <TextBlock Text="current folder" Margin="6,0,0,0" VerticalAlignment="Center"/>
                                </StackPanel>
                            </Button>
                            <Button Style="{StaticResource ElevatedRoundedButton}"
                                    Margin="5,5,5,5"
                                    Width="Auto"
                                    Click="ApplyCurrentPipelineToSelectedRootFolder_Click">
                                    selected folder
                            </Button>
                            <Button Style="{StaticResource ElevatedRoundedButton}"
                                    Margin="5,5,5,5"
                                    Width="Auto"
                                    Click="StopProcessing_Click">
                               Stop processing
                            </Button>

                        </StackPanel>
                    </StackPanel>
                </StackPanel>
            </Grid>
        </Border>

        <!--Original Image-->
            <Expander x:Name="OriginalImagExpander"
                      Grid.Row="1"
                      Grid.Column="0"
                      Grid.RowSpan="3"
                      Padding="0"
                      Background="Transparent"
                      ExpandDirection="Left"
                      IsExpanded="{Binding OriginalImageIsExpanded, Mode=TwoWay}"
                      Expanded="OrigExpander_Expanded"
                      Collapsed="OrigExpander_Collapsed">
                <Expander.Header>
                    <TextBlock
                        VerticalAlignment="Center"
                        Padding="0,0,5,0"
                        Opacity="0.8"
                        FontSize="11"
                        FontStyle="Italic"
                        Text = "Original Image">
                        <TextBlock.LayoutTransform>
                            <RotateTransform Angle="-90" />
                        </TextBlock.LayoutTransform>
                    </TextBlock>
                </Expander.Header>
                <Border 
                    BorderThickness="0"
                    BorderBrush="#FFBDBDBD"
                    Margin="5,5,5,5"
                    Padding="5"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    SnapsToDevicePixels="True"
                    CornerRadius="6">
                    <Viewbox x:Name="OrigViewbox" Stretch="Uniform">
                        <Image x:Name="OrigImgBox"
                               RenderOptions.BitmapScalingMode="HighQuality"
                               Source="{Binding OriginalImage}"
                               Stretch="None"/>
                    </Viewbox>
                </Border>
            </Expander>
        

        <!-- Navigation controls -->
        <Grid Grid.Row="3" Grid.Column="1"
            HorizontalAlignment="Stretch"
            VerticalAlignment="Center">


            <StackPanel Orientation="Vertical"
                HorizontalAlignment="Stretch">
                <TextBlock  Grid.Row="0" Margin="5,5,5,5"
                    HorizontalAlignment="Center">
                    Current folder / image navigation
                </TextBlock>
                <UniformGrid Grid.Row="1" Rows="1" Columns="3" Margin="10"
                             
                             HorizontalAlignment="Stretch">

                    <Button Style="{StaticResource ElevatedRoundedButton}"
                            Margin="0,0,10,0"
                            Click="OpenPrevFile_Click">
                            Prev
                    </Button>
                    <Button Style="{StaticResource ElevatedRoundedButton}"
                            Margin="10,0" 
                            Click="ResetButton_Click">
                            Reset Image
                    </Button>
                    <Button Style="{StaticResource ElevatedRoundedButton}"
                            Margin="10,0,0,0"
                            Click="OpenNextFile_Click">
                            Next
                    </Button>

                </UniformGrid>
            </StackPanel>


        </Grid>



        <!--Processing Image preview -->
        <Border x:Name="ProcessingPreviewBorder"
                Grid.Row="1" Grid.Column="2" Grid.RowSpan="3"
                BorderThickness="0"
                BorderBrush="#FFBDBDBD"
                Margin="5"
                Padding="5"
                HorizontalAlignment="Center"
                VerticalAlignment="Center"
                SnapsToDevicePixels="True"
                CornerRadius="6">
            <Grid x:Name="SplitPreviewHost">
                <Border x:Name="PrimaryPreviewContainer"
                        Visibility="{Binding ShowPrimaryPreview, Converter={StaticResource BoolToVis}}"
                        Panel.ZIndex="5">
                    <Border.Style>
                        <Style TargetType="Border">
                            <Setter Property="HorizontalAlignment" Value="Stretch"/>
                            <Setter Property="VerticalAlignment" Value="Stretch"/>
                            <Setter Property="Width" Value="Auto"/>
                            <Setter Property="Height" Value="Auto"/>
                            <Setter Property="Padding" Value="0"/>
                            <Setter Property="Background" Value="Transparent"/>
                            <Setter Property="BorderBrush" Value="Transparent"/>
                            <Setter Property="BorderThickness" Value="0"/>
                            <Setter Property="Effect" Value="{x:Null}"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding HasFocusedSplitPreview}" Value="True">
                                    <Setter Property="HorizontalAlignment" Value="Center"/>
                                    <Setter Property="VerticalAlignment" Value="Center"/>
                                    <Setter Property="Padding" Value="6"/>
                                    <Setter Property="CornerRadius" Value="10"/>
                                    <Setter Property="Background" Value="#F21F232B"/>
                                    <Setter Property="BorderBrush" Value="#FF1E66E0"/>
                                    <Setter Property="BorderThickness" Value="1"/>
                                    <Setter Property="Effect">
                                        <Setter.Value>
                                            <DropShadowEffect BlurRadius="15" ShadowDepth="4" Opacity="0.35"/>
                                        </Setter.Value>
                                    </Setter>
                                    <Setter Property="MaxWidth">
                                        <Setter.Value>
                                            <Binding ElementName="ProcessingImageColumn"
                                                     Path="ActualWidth"
                                                     Converter="{StaticResource MultiplyConverter}"
                                                     ConverterParameter="0.95"/>
                                        </Setter.Value>
                                    </Setter>
                                    <Setter Property="MaxHeight">
                                        <Setter.Value>
                                            <Binding ElementName="MainContentRow"
                                                     Path="ActualHeight"
                                                     Converter="{StaticResource MultiplyConverter}"
                                                     ConverterParameter="0.95"/>
                                        </Setter.Value>
                                    </Setter>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Border.Style>
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        <Border Grid.Row="0"
                                Background="#AA1C1F24"
                                CornerRadius="6,6,0,0"
                                Padding="6,2"
                                Visibility="{Binding HasFocusedSplitPreview, Converter={StaticResource BoolToVis}}">
                            <DockPanel LastChildFill="False">
                                <TextBlock Text="Focused preview"
                                           Foreground="White"
                                           FontSize="11"
                                           VerticalAlignment="Center"
                                           Opacity="0.8"/>
                                <Button Content="×"
                                        Style="{StaticResource PreviewCloseButtonStyle}"
                                        DockPanel.Dock="Right"
                                        Margin="4,0,0,0"
                                        Click="CloseFocusedPreviewButton_Click"/>
                            </DockPanel>
                        </Border>
                        <Viewbox Grid.Row="1"
                                 x:Name="PreviewViewbox"
                                 Stretch="Uniform"
                                 MouseMove="PreviewImgBox_MouseMove"
                                 MouseWheel="PreviewImgBox_MouseWheel"
                                 PreviewMouseLeftButtonDown="PreviewViewbox_PreviewMouseLeftButtonDown"
                                 PreviewMouseLeftButtonUp="PreviewViewbox_PreviewMouseLeftButtonUp">
                            <Image x:Name="PreviewImgBox"
                                   RenderOptions.BitmapScalingMode="HighQuality"
                                   Source="{Binding PrimaryPreviewImage}"
                                   Stretch="None"/>
                        </Viewbox>
                    </Grid>
                </Border>

                <Grid Visibility="{Binding IsVerticalSplitPreview, Converter={StaticResource BoolToVis}}">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition/>
                        <ColumnDefinition/>
                    </Grid.ColumnDefinitions>
                    <Viewbox Grid.Column="0"
                             Style="{StaticResource SplitPreviewTileStyle0}"
                             Tag="0"
                             MouseLeftButtonUp="SplitPreviewTile_MouseLeftButtonUp">
                        <Image RenderOptions.BitmapScalingMode="HighQuality"
                               Stretch="None">
                            <Image.Style>
                                <Style TargetType="Image">
                                    <Setter Property="Source" Value="{Binding ImageOnPreview}"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsPageSplitPreview}" Value="True">
                                            <Setter Property="Source" Value="{Binding SplitPreviewLeft}"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Image.Style>
                        </Image>
                    </Viewbox>
                    <Viewbox Grid.Column="1"
                             Style="{StaticResource SplitPreviewTileStyle1}"
                             Tag="1"
                             MouseLeftButtonUp="SplitPreviewTile_MouseLeftButtonUp">
                        <Image RenderOptions.BitmapScalingMode="HighQuality"
                               Stretch="None">
                            <Image.Style>
                                <Style TargetType="Image">
                                    <Setter Property="Source" Value="{Binding ImageOnPreview}"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsPageSplitPreview}" Value="True">
                                            <Setter Property="Source" Value="{Binding SplitPreviewRight}"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Image.Style>
                        </Image>
                    </Viewbox>
                </Grid>

                <Grid Visibility="{Binding IsHorizontalSplitPreview, Converter={StaticResource BoolToVis}}">
                    <Grid.RowDefinitions>
                        <RowDefinition/>
                        <RowDefinition/>
                    </Grid.RowDefinitions>
                    <Viewbox Grid.Row="0"
                             Style="{StaticResource SplitPreviewTileStyle0}"
                             Tag="0"
                             MouseLeftButtonUp="SplitPreviewTile_MouseLeftButtonUp">
                        <Image RenderOptions.BitmapScalingMode="HighQuality"
                               Stretch="None">
                            <Image.Style>
                                <Style TargetType="Image">
                                    <Setter Property="Source" Value="{Binding ImageOnPreview}"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsPageSplitPreview}" Value="True">
                                            <Setter Property="Source" Value="{Binding SplitPreviewLeft}"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Image.Style>
                        </Image>
                    </Viewbox>
                    <Viewbox Grid.Row="1"
                             Style="{StaticResource SplitPreviewTileStyle1}"
                             Tag="1"
                             MouseLeftButtonUp="SplitPreviewTile_MouseLeftButtonUp">
                        <Image RenderOptions.BitmapScalingMode="HighQuality"
                               Stretch="None">
                            <Image.Style>
                                <Style TargetType="Image">
                                    <Setter Property="Source" Value="{Binding ImageOnPreview}"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsPageSplitPreview}" Value="True">
                                            <Setter Property="Source" Value="{Binding SplitPreviewRight}"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Image.Style>
                        </Image>
                    </Viewbox>
                </Grid>
                <Grid Visibility="{Binding IsQuadSplitPreview, Converter={StaticResource BoolToVis}}">
                    <Grid.RowDefinitions>
                        <RowDefinition/>
                        <RowDefinition/>
                    </Grid.RowDefinitions>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition/>
                        <ColumnDefinition/>
                    </Grid.ColumnDefinitions>
                    <Viewbox Grid.Row="0" Grid.Column="0"
                             Style="{StaticResource SplitPreviewTileStyle0}"
                             Tag="0"
                             MouseLeftButtonUp="SplitPreviewTile_MouseLeftButtonUp">
                        <Image RenderOptions.BitmapScalingMode="HighQuality"
                               Source="{Binding ImageOnPreview}"
                               Stretch="None"/>
                    </Viewbox>
                    <Viewbox Grid.Row="0" Grid.Column="1"
                             Style="{StaticResource SplitPreviewTileStyle1}"
                             Tag="1"
                             MouseLeftButtonUp="SplitPreviewTile_MouseLeftButtonUp">
                        <Image RenderOptions.BitmapScalingMode="HighQuality"
                               Source="{Binding ImageOnPreview}"
                               Stretch="None"/>
                    </Viewbox>
                    <Viewbox Grid.Row="1" Grid.Column="0"
                             Style="{StaticResource SplitPreviewTileStyle2}"
                             Tag="2"
                             MouseLeftButtonUp="SplitPreviewTile_MouseLeftButtonUp">
                        <Image RenderOptions.BitmapScalingMode="HighQuality"
                               Source="{Binding ImageOnPreview}"
                               Stretch="None"/>
                    </Viewbox>
                    <Viewbox Grid.Row="1" Grid.Column="1"
                             Style="{StaticResource SplitPreviewTileStyle3}"
                             Tag="3"
                             MouseLeftButtonUp="SplitPreviewTile_MouseLeftButtonUp">
                        <Image RenderOptions.BitmapScalingMode="HighQuality"
                               Source="{Binding ImageOnPreview}"
                               Stretch="None"/>
                    </Viewbox>
                </Grid>
                <Grid Visibility="{Binding IsSixSplitPreview, Converter={StaticResource BoolToVis}}">
                    <Grid.RowDefinitions>
                        <RowDefinition/>
                        <RowDefinition/>
                    </Grid.RowDefinitions>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition/>
                        <ColumnDefinition/>
                        <ColumnDefinition/>
                    </Grid.ColumnDefinitions>
                    <Viewbox Grid.Row="0" Grid.Column="0"
                             Style="{StaticResource SplitPreviewTileStyle0}"
                             Tag="0"
                             MouseLeftButtonUp="SplitPreviewTile_MouseLeftButtonUp">
                        <Image RenderOptions.BitmapScalingMode="HighQuality"
                               Source="{Binding ImageOnPreview}"
                               Stretch="None"/>
                    </Viewbox>
                    <Viewbox Grid.Row="0" Grid.Column="1"
                             Style="{StaticResource SplitPreviewTileStyle1}"
                             Tag="1"
                             MouseLeftButtonUp="SplitPreviewTile_MouseLeftButtonUp">
                        <Image RenderOptions.BitmapScalingMode="HighQuality"
                               Source="{Binding ImageOnPreview}"
                               Stretch="None"/>
                    </Viewbox>
                    <Viewbox Grid.Row="0" Grid.Column="2"
                             Style="{StaticResource SplitPreviewTileStyle2}"
                             Tag="2"
                             MouseLeftButtonUp="SplitPreviewTile_MouseLeftButtonUp">
                        <Image RenderOptions.BitmapScalingMode="HighQuality"
                               Source="{Binding ImageOnPreview}"
                               Stretch="None"/>
                    </Viewbox>
                    <Viewbox Grid.Row="1" Grid.Column="0"
                             Style="{StaticResource SplitPreviewTileStyle3}"
                             Tag="3"
                             MouseLeftButtonUp="SplitPreviewTile_MouseLeftButtonUp">
                        <Image RenderOptions.BitmapScalingMode="HighQuality"
                               Source="{Binding ImageOnPreview}"
                               Stretch="None"/>
                    </Viewbox>
                    <Viewbox Grid.Row="1" Grid.Column="1"
                             Style="{StaticResource SplitPreviewTileStyle4}"
                             Tag="4"
                             MouseLeftButtonUp="SplitPreviewTile_MouseLeftButtonUp">
                        <Image RenderOptions.BitmapScalingMode="HighQuality"
                               Source="{Binding ImageOnPreview}"
                               Stretch="None"/>
                    </Viewbox>
                    <Viewbox Grid.Row="1" Grid.Column="2"
                             Style="{StaticResource SplitPreviewTileStyle5}"
                             Tag="5"
                             MouseLeftButtonUp="SplitPreviewTile_MouseLeftButtonUp">
                        <Image RenderOptions.BitmapScalingMode="HighQuality"
                               Source="{Binding ImageOnPreview}"
                               Stretch="None"/>
                    </Viewbox>
                </Grid>

            </Grid>
        </Border>

    </Grid>
    </AdornerDecorator>

</Window>
